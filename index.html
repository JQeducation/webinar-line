<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å ±åæˆåŠŸ</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; background-color: #f5f5f5; padding: 20px; box-sizing: border-box; }
        .container { background: white; padding: 40px 30px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); text-align: center; max-width: 400px; width: 100%; }
        h1 { color: #06c755; margin: 0 0 15px 0; font-size: 24px; }
        p { color: #555; line-height: 1.6; margin: 0 0 25px 0; font-size: 15px; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #06c755; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn { display: inline-block; width: 100%; padding: 15px 0; border-radius: 10px; text-decoration: none; border: none; font-size: 16px; cursor: pointer; font-weight: bold; transition: background 0.3s; margin-bottom: 10px; box-sizing: border-box; }
        .btn-primary { background-color: #06c755; color: white; box-shadow: 0 4px 6px rgba(6, 199, 85, 0.2); }
        .btn-primary:hover { background-color: #05a546; }
        .btn-secondary { background-color: #e0e0e0; color: #555; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="loading" class="container"><div class="loader"></div><p>æ­£åœ¨ç¢ºèªæ‚¨çš„å ±åè³‡æ–™...</p></div>
    <div id="success" class="container hidden">
        <h1>ğŸ‰ å ±åæˆåŠŸï¼</h1>
        <p>è¦ªæ„›çš„ <b id="user-name"></b>ï¼Œ<br>è³‡æ–™å·²ç¢ºèªï¼Œæ­¡è¿åŠ å…¥ç›´æ’­ï¼</p>
        <a id="watch-btn" href="#" class="btn btn-primary">ğŸ‘‰ é»æ“Šé€²å…¥è¬›åº§ç›´æ’­é–“</a>
        <p style="font-size:12px; color:#999; margin-top:15px;">( å°ˆå±¬é€£çµå·²ç™¼é€è‡³æ‚¨çš„ LINE )</p>
        <button class="btn btn-secondary" onclick="liff.closeWindow()">é—œé–‰è¦–çª—</button>
    </div>
    <div id="error" class="container hidden"><h1 style="color:#ff4b4b;">âŒ ç™¼ç”ŸéŒ¯èª¤</h1><p>ç„¡æ³•é€£ç·šï¼Œè«‹ç¢ºèªç¶²è·¯å¾Œé‡æ–°é»æ“Šé€£çµã€‚</p><button class="btn btn-secondary" onclick="window.location.reload()">é‡æ–°æ•´ç†</button></div>

    <script>
        // ğŸ‘‡ğŸ‘‡ğŸ‘‡ è¨­å®šå€ (ç¢ºèªIDç„¡èª¤) ğŸ‘‡ğŸ‘‡ğŸ‘‡
        const MyLiffId = '2009072858-Mu8lyOVs'; 
        const MakeWebhookUrl = 'https://hook.us2.make.com/n8ep5dajfie8xtfdrd8x7q9qbgd3jaz2'; 
        const WebinarID = '698712f14a815254bf7a1beb';
        // ğŸ‘†ğŸ‘†ğŸ‘† è¨­å®šçµæŸ ğŸ‘†ğŸ‘†ğŸ‘†

        async function main() {
            try {
                await liff.init({ liffId: MyLiffId });

                const currentUrl = new URL(window.location.href);
                const searchParams = currentUrl.searchParams;

                // 1. ç™»å…¥æª¢æŸ¥èˆ‡è½‰å€
                if (!liff.isLoggedIn()) {
                    liff.login({ redirectUri: window.location.href });
                    return;
                }

                // --- ç™»å…¥å¾ŒåŸ·è¡Œ ---
                const profile = await liff.getProfile();
                
                // 2. ğŸŒŸ é—œéµä¿®æ”¹ï¼šåš´æ ¼æŒ‰ç…§æŒ‡å®šé †åºæ’åˆ— ğŸŒŸ
                // é †åºï¼št -> r -> first_name -> email -> phone_number
                const allowedKeys = ['t', 'r', 'first_name', 'email', 'phone_number'];
                
                const usefulParams = new URLSearchParams();

                // ä¾ç…§ä¸Šé¢çš„é †åºï¼Œä¸€å€‹ä¸€å€‹æŠŠåƒæ•¸æŠ“é€²ä¾† (å¦‚æœå­˜åœ¨çš„è©±)
                for (const key of allowedKeys) {
                    if (searchParams.has(key)) {
                        usefulParams.append(key, searchParams.get(key));
                    }
                }
                
                // 3. ç”¢ç”Ÿæœ€çµ‚å­—ä¸² (ä¾‹å¦‚: t=...&r=...&first_name=...)
                const finalQueryString = usefulParams.toString();

                // é¡¯ç¤ºåå­—
                const userFirstName = usefulParams.get('first_name');
                document.getElementById('user-name').textContent = userFirstName || profile.displayName;

                // 4. å‚³é€çµ¦ Make
                const response = await fetch(MakeWebhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        line_id: profile.userId,
                        nickname: profile.displayName,
                        picture: profile.pictureUrl,
                        // ğŸ‘‡ é€™ä¸²ç¾åœ¨æœƒæ˜¯å®Œç¾çš„é †åº
                        query_string: finalQueryString 
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.url) {
                        document.getElementById('watch-btn').href = data.url;
                    } else {
                        // å‚™æ¡ˆçµ„è£
                        if (finalQueryString) {
                            document.getElementById('watch-btn').href = `https://webinar.archiestudio.co/webinar/watch/${WebinarID}?${finalQueryString}`;
                        } else {
                            document.getElementById('watch-btn').href = `https://webinar.archiestudio.co/webinar/login/${WebinarID}`;
                        }
                    }

                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('success').classList.remove('hidden');
                } else { throw new Error('Make Response Error'); }

            } catch (err) {
                console.error(err);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error').classList.remove('hidden');
            }
        }
        main();
    </script>
</body>
</html>
